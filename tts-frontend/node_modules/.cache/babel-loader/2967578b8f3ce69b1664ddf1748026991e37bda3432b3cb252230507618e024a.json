{"ast":null,"code":"import { mapState } from 'vuex';\nexport default {\n  name: 'TTSGenerator',\n  data() {\n    return {\n      inputText: '',\n      selectedSpeaker: '',\n      audioUrl: '',\n      isGenerating: false,\n      error: ''\n    };\n  },\n  watch: {\n    speakers(newSpeakers) {\n      if (newSpeakers && newSpeakers.length > 0) {\n        this.selectedSpeaker = newSpeakers[0];\n      } else {\n        this.selectedSpeaker = '';\n      }\n    }\n  },\n  computed: {\n    ...mapState('tts', {\n      speakers: state => state.speakers,\n      isLoading: state => state.isLoading,\n      ttsError: state => state.error\n    })\n  },\n  mounted() {\n    // 加载说话人列表\n    this.$store.dispatch('tts/fetchSpeakers');\n  },\n  methods: {\n    async generateSpeech() {\n      // 1. 先校验输入（新增：避免空文本请求）\n      if (!this.inputText.trim()) {\n        this.error = '请输入要转换的文字';\n        return;\n      }\n      if (!this.selectedSpeaker) {\n        this.error = '请选择说话人';\n        return;\n      }\n      this.isGenerating = true;\n      this.error = '';\n      this.audioUrl = '';\n      try {\n        // 2. 传入关键参数（inputText + selectedSpeaker）\n        const response = await this.$api.generateTTS({\n          text: this.inputText.trim(),\n          speaker: this.selectedSpeaker\n        });\n        if (response.data?.result === \"success\" && response.data?.file_path) {\n          // 3. 用API返回的绝对路径（避免相对路径部署问题）\n          this.audioUrl = `${process.env.VUE_APP_API_URL}/${response.data.file_path}`;\n          // 4. 实现音频可用性检测（监听audio错误）\n          await this.testAudioAvailability(this.audioUrl);\n        } else {\n          throw new Error('语音生成成功，但未返回音频路径');\n        }\n      } catch (error) {\n        console.error('生成语音失败:', error);\n        this.error = `生成失败：${error.message || '未知错误'}`;\n      } finally {\n        this.isGenerating = false; // 无论成功失败，都关闭加载状态\n      }\n    },\n    // 5. 实现音频检测方法（新增）\n    async testAudioAvailability(audioUrl) {\n      return new Promise((resolve, reject) => {\n        const audio = new Audio(audioUrl);\n        audio.onloadeddata = () => resolve(); // 加载成功\n        audio.onerror = err => {\n          this.error = '音频加载失败，请重试';\n          reject(err);\n        };\n      });\n    },\n    copyShareLink() {\n      if (!this.audioUrl) return;\n\n      // 用完整URL（基于环境变量，确保部署后可用）\n      const fullShareUrl = window.location.origin + this.audioUrl;\n      navigator.clipboard.writeText(fullShareUrl).then(() => alert('分享链接已复制到剪贴板')).catch(err => {\n        console.error('复制失败:', err);\n        alert('复制失败，请手动复制：' + fullShareUrl); // 新增：显示手动复制链接\n      });\n    }\n  }\n};","map":{"version":3,"names":["mapState","name","data","inputText","selectedSpeaker","audioUrl","isGenerating","error","watch","speakers","newSpeakers","length","computed","state","isLoading","ttsError","mounted","$store","dispatch","methods","generateSpeech","trim","response","$api","generateTTS","text","speaker","result","file_path","process","env","VUE_APP_API_URL","testAudioAvailability","Error","console","message","Promise","resolve","reject","audio","Audio","onloadeddata","onerror","err","copyShareLink","fullShareUrl","window","location","origin","navigator","clipboard","writeText","then","alert","catch"],"sources":["src/components/TTSGenerator.vue"],"sourcesContent":["<template>\n  <div class=\"tts-generator\">\n    <h2>文字转语音生成器</h2>\n\n    <!-- 加载状态提示 -->\n    <div v-if=\"isLoading\" class=\"loading-message\">\n      加载说话人列表中...\n    </div>\n\n    <div class=\"input-section\">\n      <textarea\n          v-model=\"inputText\"\n          placeholder=\"输入要转换的文字...\"\n          rows=\"5\"\n          class=\"text-input\"\n      ></textarea>\n\n      <div class=\"controls\">\n        <!-- 说话人选择器 -->\n        <div class=\"speaker-select\" v-if=\"speakers && speakers.length > 0\">\n          <label>说话人:</label>\n          <select v-model=\"selectedSpeaker\">\n            <option v-for=\"speaker in speakers\" :key=\"speaker\" :value=\"speaker\">\n              {{ speaker }}\n            </option>\n          </select>\n        </div>\n\n        <!-- 无说话人时的提示 -->\n        <div v-else-if=\"!isLoading\" class=\"no-speakers\">\n          无可用说话人\n        </div>\n\n        <!-- 生成按钮 -->\n        <button\n            @click=\"generateSpeech\"\n            :disabled=\"isGenerating || isLoading\"\n            class=\"generate-btn\"\n        >\n          <span v-if=\"isGenerating\">生成中...</span>\n          <span v-else>生成语音</span>\n        </button>\n      </div>\n    </div>\n\n    <!-- 音频播放区域 -->\n    <div class=\"audio-section\" v-if=\"audioUrl\">\n      <audio :src=\"audioUrl\" controls class=\"audio-player\"></audio>\n      <div class=\"audio-actions\">\n        <a :href=\"audioUrl\" download=\"generated_speech.wav\" class=\"download-btn\">\n          下载音频\n        </a>\n        <button @click=\"copyShareLink\" class=\"share-btn\">\n          复制分享链接\n        </button>\n      </div>\n    </div>\n\n    <!-- 错误信息显示 -->\n    <div v-if=\"error\" class=\"error-message\">\n      {{ error }}\n    </div>\n\n    <!-- Vuex 错误信息显示 -->\n    <div v-if=\"ttsError\" class=\"error-message\">\n      {{ ttsError }}\n    </div>\n  </div>\n</template>\n\n<script>\nimport { mapState } from 'vuex';\n\nexport default {\n  name: 'TTSGenerator',\n  data() {\n    return {\n      inputText: '',\n      selectedSpeaker: '',\n      audioUrl: '',\n      isGenerating: false,\n      error: ''\n    };\n  },\n  watch: {\n    speakers(newSpeakers) {\n      if (newSpeakers && newSpeakers.length > 0) {\n        this.selectedSpeaker = newSpeakers[0];\n      } else {\n        this.selectedSpeaker = '';\n      }\n    }\n  },\n  computed: {\n    ...mapState('tts', {\n      speakers: state => state.speakers,\n      isLoading: state => state.isLoading,\n      ttsError: state => state.error\n    })\n  },\n  mounted() {\n    // 加载说话人列表\n    this.$store.dispatch('tts/fetchSpeakers');\n  },\n  methods: {\n    async generateSpeech() {\n      // 1. 先校验输入（新增：避免空文本请求）\n      if (!this.inputText.trim()) {\n        this.error = '请输入要转换的文字';\n        return;\n      }\n      if (!this.selectedSpeaker) {\n        this.error = '请选择说话人';\n        return;\n      }\n\n      this.isGenerating = true;\n      this.error = '';\n      this.audioUrl = '';\n\n      try {\n        // 2. 传入关键参数（inputText + selectedSpeaker）\n        const response = await this.$api.generateTTS({\n          text: this.inputText.trim(),\n          speaker: this.selectedSpeaker\n        });\n\n        if (response.data?.result === \"success\" && response.data?.file_path) {\n          // 3. 用API返回的绝对路径（避免相对路径部署问题）\n          this.audioUrl = `${process.env.VUE_APP_API_URL}/${response.data.file_path}`;\n          // 4. 实现音频可用性检测（监听audio错误）\n          await this.testAudioAvailability(this.audioUrl);\n        } else {\n          throw new Error('语音生成成功，但未返回音频路径');\n        }\n      } catch (error) {\n        console.error('生成语音失败:', error);\n        this.error = `生成失败：${error.message || '未知错误'}`;\n      } finally {\n        this.isGenerating = false; // 无论成功失败，都关闭加载状态\n      }\n    },\n\n// 5. 实现音频检测方法（新增）\n    async testAudioAvailability(audioUrl) {\n      return new Promise((resolve, reject) => {\n        const audio = new Audio(audioUrl);\n        audio.onloadeddata = () => resolve(); // 加载成功\n        audio.onerror = (err) => {\n          this.error = '音频加载失败，请重试';\n          reject(err);\n        };\n      });\n    },\n\n    copyShareLink() {\n      if (!this.audioUrl) return;\n\n      // 用完整URL（基于环境变量，确保部署后可用）\n      const fullShareUrl = window.location.origin + this.audioUrl;\n      navigator.clipboard.writeText(fullShareUrl)\n          .then(() => alert('分享链接已复制到剪贴板'))\n          .catch(err => {\n            console.error('复制失败:', err);\n            alert('复制失败，请手动复制：' + fullShareUrl); // 新增：显示手动复制链接\n          });\n    },\n  },\n};\n</script>\n\n<style scoped>\n.tts-generator {\n  max-width: 800px;\n  margin: 0 auto;\n  padding: 30px;\n  background-color: #ffffff;\n  border-radius: 12px;\n  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);\n}\n\nh2 {\n  text-align: center;\n  color: #2c3e50;\n  margin-bottom: 25px;\n  font-size: 28px;\n}\n\n.input-section {\n  margin-bottom: 25px;\n}\n\n.text-input {\n  width: 100%;\n  padding: 15px;\n  border: 1px solid #e0e0e0;\n  border-radius: 8px;\n  font-size: 16px;\n  line-height: 1.5;\n  resize: vertical;\n  transition: border-color 0.3s;\n}\n\n.text-input:focus {\n  border-color: #3498db;\n  outline: none;\n  box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);\n}\n\n.controls {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-top: 15px;\n}\n\n.speaker-select {\n  display: flex;\n  align-items: center;\n}\n\n.speaker-select label {\n  margin-right: 10px;\n  color: #555;\n  font-weight: 500;\n}\n\n.speaker-select select {\n  padding: 10px 15px;\n  border: 1px solid #e0e0e0;\n  border-radius: 6px;\n  background-color: #f9f9f9;\n  font-size: 16px;\n}\n\n.no-speakers {\n  color: #777;\n  font-style: italic;\n}\n\n.generate-btn {\n  background-color: #3498db;\n  color: white;\n  border: none;\n  padding: 12px 25px;\n  border-radius: 6px;\n  font-size: 16px;\n  font-weight: 500;\n  cursor: pointer;\n  transition: background-color 0.3s;\n}\n\n.generate-btn:hover:not(:disabled) {\n  background-color: #2980b9;\n}\n\n.generate-btn:disabled {\n  background-color: #95a5a6;\n  cursor: not-allowed;\n}\n\n.audio-section {\n  margin-top: 25px;\n  padding: 20px;\n  background-color: #f8f9fa;\n  border-radius: 8px;\n  animation: fadeIn 0.5s ease;\n}\n\n@keyframes fadeIn {\n  from { opacity: 0; transform: translateY(10px); }\n  to { opacity: 1; transform: translateY(0); }\n}\n\n.audio-player {\n  width: 100%;\n  margin-bottom: 15px;\n}\n\n.audio-actions {\n  display: flex;\n  gap: 15px;\n}\n\n.download-btn, .share-btn {\n  flex: 1;\n  text-align: center;\n  padding: 12px;\n  border-radius: 6px;\n  font-weight: 500;\n  text-decoration: none;\n  transition: all 0.3s;\n}\n\n.download-btn {\n  background-color: #2ecc71;\n  color: white;\n}\n\n.download-btn:hover {\n  background-color: #27ae60;\n}\n\n.share-btn {\n  background-color: #9b59b6;\n  color: white;\n  border: none;\n  cursor: pointer;\n}\n\n.share-btn:hover {\n  background-color: #8e44ad;\n}\n\n.error-message {\n  margin-top: 20px;\n  padding: 15px;\n  background-color: #ffebee;\n  color: #c62828;\n  border-radius: 8px;\n  text-align: center;\n}\n\n.loading-message {\n  margin-top: 10px;\n  padding: 10px;\n  background-color: #e3f2fd;\n  color: #1976d2;\n  border-radius: 6px;\n  text-align: center;\n}\n</style>"],"mappings":"AAuEA,SAAAA,QAAA;AAEA;EACAC,IAAA;EACAC,KAAA;IACA;MACAC,SAAA;MACAC,eAAA;MACAC,QAAA;MACAC,YAAA;MACAC,KAAA;IACA;EACA;EACAC,KAAA;IACAC,SAAAC,WAAA;MACA,IAAAA,WAAA,IAAAA,WAAA,CAAAC,MAAA;QACA,KAAAP,eAAA,GAAAM,WAAA;MACA;QACA,KAAAN,eAAA;MACA;IACA;EACA;EACAQ,QAAA;IACA,GAAAZ,QAAA;MACAS,QAAA,EAAAI,KAAA,IAAAA,KAAA,CAAAJ,QAAA;MACAK,SAAA,EAAAD,KAAA,IAAAA,KAAA,CAAAC,SAAA;MACAC,QAAA,EAAAF,KAAA,IAAAA,KAAA,CAAAN;IACA;EACA;EACAS,QAAA;IACA;IACA,KAAAC,MAAA,CAAAC,QAAA;EACA;EACAC,OAAA;IACA,MAAAC,eAAA;MACA;MACA,UAAAjB,SAAA,CAAAkB,IAAA;QACA,KAAAd,KAAA;QACA;MACA;MACA,UAAAH,eAAA;QACA,KAAAG,KAAA;QACA;MACA;MAEA,KAAAD,YAAA;MACA,KAAAC,KAAA;MACA,KAAAF,QAAA;MAEA;QACA;QACA,MAAAiB,QAAA,cAAAC,IAAA,CAAAC,WAAA;UACAC,IAAA,OAAAtB,SAAA,CAAAkB,IAAA;UACAK,OAAA,OAAAtB;QACA;QAEA,IAAAkB,QAAA,CAAApB,IAAA,EAAAyB,MAAA,kBAAAL,QAAA,CAAApB,IAAA,EAAA0B,SAAA;UACA;UACA,KAAAvB,QAAA,MAAAwB,OAAA,CAAAC,GAAA,CAAAC,eAAA,IAAAT,QAAA,CAAApB,IAAA,CAAA0B,SAAA;UACA;UACA,WAAAI,qBAAA,MAAA3B,QAAA;QACA;UACA,UAAA4B,KAAA;QACA;MACA,SAAA1B,KAAA;QACA2B,OAAA,CAAA3B,KAAA,YAAAA,KAAA;QACA,KAAAA,KAAA,WAAAA,KAAA,CAAA4B,OAAA;MACA;QACA,KAAA7B,YAAA;MACA;IACA;IAEA;IACA,MAAA0B,sBAAA3B,QAAA;MACA,WAAA+B,OAAA,EAAAC,OAAA,EAAAC,MAAA;QACA,MAAAC,KAAA,OAAAC,KAAA,CAAAnC,QAAA;QACAkC,KAAA,CAAAE,YAAA,SAAAJ,OAAA;QACAE,KAAA,CAAAG,OAAA,GAAAC,GAAA;UACA,KAAApC,KAAA;UACA+B,MAAA,CAAAK,GAAA;QACA;MACA;IACA;IAEAC,cAAA;MACA,UAAAvC,QAAA;;MAEA;MACA,MAAAwC,YAAA,GAAAC,MAAA,CAAAC,QAAA,CAAAC,MAAA,QAAA3C,QAAA;MACA4C,SAAA,CAAAC,SAAA,CAAAC,SAAA,CAAAN,YAAA,EACAO,IAAA,OAAAC,KAAA,iBACAC,KAAA,CAAAX,GAAA;QACAT,OAAA,CAAA3B,KAAA,UAAAoC,GAAA;QACAU,KAAA,iBAAAR,YAAA;MACA;IACA;EACA;AACA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}